# 开关矩阵操作手册

---

## 目录

1. [系统概述](#1-系统概述)
2. [开关架构详解](#2-开关架构详解)
3. [连接方式](#3-连接方式)
4. [SCPI命令参考](#4-scpi命令参考)
5. [软件操作指南](#5-软件操作指南)
6. [典型应用场景](#6-典型应用场景)

---

## 1. 系统概述

### 1.1 什么是开关矩阵

开关矩阵（Switch Matrix）是一种可编程的射频信号路由设备，能够在多个输入端口和多个输出端口之间建立可控的信号通路。在射频测试系统中，开关矩阵可以实现：

- **多端口器件自动化测量**：无需手动拆装连接器，通过编程切换信号路径
- **信号路由分配**：将激励信号路由到指定的被测端口
- **系统集成**：与VNA、频谱仪等仪器协同工作，实现自动化测试

### 1.2 本系统特点

| 特性 | 规格 |
|:----:|:----:|
| 射频通道数 | 148个（CH1~CH76 + CP1~CP72） |
| 公共端口 | COM1、COM2（双公共端） |
| 控制方式 | TCP/IP网络 或 RS-232串口 |
| 控制协议 | SCPI标准命令 |
| 开关单元数 | 83个（SW1~SW83） |

---

## 2. 开关架构详解

### 2.1 系统架构图

![开关矩阵架构图](C:/Users/不负所望/.gemini/antigravity/brain/51d5f155-ac1c-4f3f-8ddf-c84ca181673c/uploaded_image_1765441736175.png)

### 2.2 三级级联架构

本矩阵开关采用**三级级联架构**，由83个开关单元组成：

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                                    开关矩阵架构                                      │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                            		 │
│  COM1 ──→ [SW82: SP10T] ──┬──→ [SW73: SP8T] ──→ SW1~SW8 ──→ CH1~CH8/CP1~CP8 	   	 │
│           (第一级)         │                                               		   │
│                           ├──→ [SW74: SP8T] ──→ SW9~SW16 ──→ CH9~CH16/CP9~CP16	 │
│                           │                                                		 │
│                           ├──→ [SW75: SP8T] ──→ SW17~SW24 ──→ CH17~CH24/...		 │
│                           │                                                		 │
│                           ├──→ ...                                          		 │
│                           │                                                		 │
│                           └──→ [SW81: SP8T] ──→ SW65~SW72 ──→ CH65~CH72/CP65~CP72  │
│                                (第二级)          (第三级)                            │
│                                                                               	 │
│  COM2 ──→ [SW83: SP4T] ──────→ CH73 / CH74 / CH75 / CH76                           │
│                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 开关分类与功能

#### 第三级：末端SPDT开关（SW1 ~ SW72）

| 开关编号 | 类型 | 状态范围 | 功能 |
|:--------:|:----:|:--------:|------|
| SW1 ~ SW72 | SPDT（单刀双掷） | 1 或 2 | 切换CHn与CPn(1≤n≤72) |

- **状态1**：连接到**CHn**端口
- **状态2**：连接到**CPn**端口

**对应关系**：

| 开关 | 状态1 | 状态2 |
|:----:|:-----:|:-----:|
| SW1 | CH1 | CP1 |
| SW2 | CH2 | CP2 |
| ... | ... | ... |
| SW72 | CH72 | CP72 |

#### 第二级：分组选择开关（SW73 ~ SW81）

| 开关编号 | 类型 | 状态范围 | 控制的末端开关 |
|:--------:|:----:|:--------:|:--------------:|
| SW73 | SP8T | 0 ~ 8 | SW1 ~ SW8 |
| SW74 | SP8T | 0 ~ 8 | SW9 ~ SW16 |
| SW75 | SP8T | 0 ~ 8 | SW17 ~ SW24 |
| SW76 | SP8T | 0 ~ 8 | SW25 ~ SW32 |
| SW77 | SP8T | 0 ~ 8 | SW33 ~ SW40 |
| SW78 | SP8T | 0 ~ 8 | SW41 ~ SW48 |
| SW79 | SP8T | 0 ~ 8 | SW49 ~ SW56 |
| SW80 | SP8T | 0 ~ 8 | SW57 ~ SW64 |
| SW81 | SP8T | 0 ~ 8 | SW65 ~ SW72 |

- **状态0**：断开（不选择任何末端开关）
- **状态1~8**：选择该组内的第1~8个末端开关

**示例**：`SW73:3` 表示SW73切换到状态3，即选择SW3

#### 第一级：主选择开关（SW82）

| 开关编号 | 类型 | 状态范围 | 控制的分组开关 |
|:--------:|:----:|:--------:|:--------------:|
| SW82 | SP10T | 0 ~ 9 | SW73 ~ SW81 |

- **状态0**：断开（不选择任何分组）
- **状态1~9**：选择SW73~SW81

**对应关系**：
| SW82状态 | 连接到 | 覆盖通道范围 |
|:--------:|:------:|:------------:|
| 0 | 断开 | - |
| 1 | SW73 | CH1~CH8 / CP1~CP8 |
| 2 | SW74 | CH9~CH16 / CP9~CP16 |
| 3 | SW75 | CH17~CH24 / CP17~CP24 |
| 4 | SW76 | CH25~CH32 / CP25~CP32 |
| 5 | SW77 | CH33~CH40 / CP33~CP40 |
| 6 | SW78 | CH41~CH48 / CP41~CP48 |
| 7 | SW79 | CH49~CH56 / CP49~CP56 |
| 8 | SW80 | CH57~CH64 / CP57~CP64 |
| 9 | SW81 | CH65~CH72 / CP65~CP72 |

#### COM2端选择开关（SW83）

| 开关编号 | 类型 | 状态范围 | 连接端口 |
|:--------:|:----:|:--------:|:--------:|
| SW83 | SP4T | 0 ~ 4 | CH73~CH76 |

| SW83状态 | 连接到 |
|:--------:|:------:|
| 0 | 断开 |
| 1 | CH73 |
| 2 | CH74 |
| 3 | CH75 |
| 4 | CH76 |

### 2.4 通道类型说明

| 通道类型 | 编号范围 | 数量 | 说明 |
|:--------:|:--------:|:----:|------|
| CH | CH1 ~ CH72 | 72 | 主通道，通过SW1~SW72的状态1连接 |
| CP | CP1 ~ CP72 | 72 | 副通道，通过SW1~SW72的状态2连接 |
| CH(特殊) | CH73 ~ CH76 | 4 | COM2专用通道，通过SW83选择 |

### 2.5 开关状态汇总表

| 开关编号 | 开关类型 | 状态范围 | 功能描述 |
|:--------:|:--------:|:--------:|----------|
| SW1 ~ SW72 | SPDT | 1 或 2 | 切换CHn(状态1) / CPn(状态2) |
| SW73 ~ SW81 | SP8T | 0 ~ 8 | 选择组内的8个SPDT开关之一 |
| SW82 | SP10T | 0 ~ 9 | 选择9个SP8T分组开关之一（连接COM1） |
| SW83 | SP4T | 0 ~ 4 | 选择CH73~CH76之一（连接COM2） |

---

## 3. 连接方式

### 3.1 网络连接（推荐）

网络连接是推荐的控制方式，具有连接稳定、距离不受限制、支持远程控制等优点。

#### 连接步骤

1. 使用标准网线连接矩阵开关的以太网端口到电脑或交换机
2. 确保电脑与矩阵开关在同一网段（默认：`192.168.2.x`）
3. 在软件中选择"网络 (TCP/IP)"连接方式
4. 输入设备IP地址和端口号：
   - **默认IP**：`192.168.2.11`
   - **默认端口**：`5025`
5. 点击"连接设备"

#### 网络配置要求

- 电脑IP设置：`192.168.2.xxx`（xxx ≠ 11）
- 子网掩码：`255.255.255.0`
- 网关：`192.168.2.1`（如需要）

### 3.2 串口连接

串口连接适用于无网络环境或特殊调试场景。

#### 连接步骤

1. 使用RS-232直通线连接矩阵开关与电脑串口
2. 如电脑无串口，可使用USB转串口适配器
3. 在软件中选择"串口 (COM)"连接方式
4. 选择对应的COM端口
5. 设置波特率（建议：`115200`）
6. 点击"连接设备"

#### 串口参数

| 参数 | 设置值 |
|------|--------|
| 波特率 | 9600 或 115200 |
| 数据位 | 8 |
| 停止位 | 1 |
| 校验位 | 无 |

### 3.3 连接验证

连接成功后，可发送握手命令验证通信：

```
*IDN?
```

---

## 4. SCPI命令参考

### 4.1 命令格式说明

本系统采用SCPI标准命令格式：

- 命令不区分大小写
- 命令以换行符（`\n`）结束
- 查询命令以问号（`?`）结尾

### 4.2 系统命令

| 命令 | 功能 | 响应 |
|------|------|------|
| `*IDN?` | 查询设备标识 | 设备信息字符串 |
| `ifconfig` | 查询网络配置 | IP/掩码/网关信息 |

### 4.3 ROUTE:PATHSWITCH — 建立路径

**功能**：一次性配置COM1和COM2的连接路径（自动控制多级开关）

**语法**：
```
ROUTE:PATHSWITCH:<A1_NUM>:<A2_NUM>
```

**参数说明**：

| 参数 | 范围 | 说明 |
|:----:|:----:|------|
| A1_NUM | 0 ~ 72 | COM1连接的目标通道号 |
| A2_NUM | 0, 73~76 | COM2连接的目标通道号 |

**A1_NUM 详解**：
- `0`：透传模式（所有SW1~SW72切换到CP侧）
- `1~72`：COM1连接到指定的CH通道

**A2_NUM 详解**：
- `0`：COM2断开
- `73~76`：COM2连接到CH73/74/75/76

**内部执行逻辑**：
当执行 `ROUTE:PATHSWITCH:N:M` 时，系统自动：
1. 根据N计算所需的SW82、SW7x、SWn状态
2. 根据M设置SW83状态
3. 依次执行所有开关切换

**示例**：

```bash
# COM1连接CH5，COM2连接CH73
ROUTE:PATHSWITCH:5:73
# 内部执行：SW82→1, SW73→5, SW5→1, SW83→1

# COM1连接CH35，COM2连接CH75
ROUTE:PATHSWITCH:35:75
# 内部执行：SW82→5, SW77→3, SW35→1, SW83→3

# 透传模式：所有通道直连CP
ROUTE:PATHSWITCH:0:0
```

**查询当前路径**：
```
ROUTE:PATHSWITCH?
```

---

### 4.4 ROUTE:CHANGETO — 快速切换

**功能**：直接控制单个开关的状态（底层命令）

**语法**：
```
ROUTE:CHANGETO:<NUM1>:<NUM2>
```

**参数说明**：

| 参数 | 说明 |
|:----:|------|
| NUM1 | 开关编号（1 ~ 83） |
| NUM2 | 目标状态 |

**开关状态范围**：

| 开关编号 | 类型 | NUM2范围 | 状态含义 |
|:--------:|:----:|:--------:|----------|
| 1 ~ 72 | SPDT | 1 或 2 | 1=CHn, 2=CPn |
| 73 ~ 81 | SP8T | 0 ~ 8 | 0=断开, 1~8=选择组内开关 |
| 82 | SP10T | 0 ~ 9 | 0=断开, 1~9=选择分组 |
| 83 | SP4T | 0 ~ 4 | 0=断开, 1~4=CH73~CH76 |

**示例**：

```bash
# SW1切换到CH1（状态1）
ROUTE:CHANGETO:1:1

# SW1切换到CP1（状态2）
ROUTE:CHANGETO:1:2

# SW73选择第3路（连接SW3）
ROUTE:CHANGETO:73:3

# SW82选择第1组（连接SW73）
ROUTE:CHANGETO:82:1

# SW83连接CH74
ROUTE:CHANGETO:83:2
```

**查询开关状态**：
```
ROUTE:CHANGETO:<NUM1>?
```

---

### 4.5 PATHSWITCH 与 CHANGETO 的关系

> [!IMPORTANT]
> **PATHSWITCH** 是高级命令，内部通过多次调用 **CHANGETO** 实现路径建立。

**等价关系示例**：

执行 `ROUTE:PATHSWITCH:5:73` 等价于：
```bash
ROUTE:CHANGETO:82:1     # SW82选择第1组(SW73)
ROUTE:CHANGETO:73:5     # SW73选择第5路(SW5)
ROUTE:CHANGETO:5:1      # SW5切换到CH5
ROUTE:CHANGETO:83:1     # SW83选择CH73
```

| 场景 | 推荐命令 |
|------|----------|
| 快速建立完整路径 | PATHSWITCH |
| 精细控制单个开关 | CHANGETO |
| 仅切换CH/CP | CHANGETO:1~72 |
| 调试/排故 | CHANGETO |

---

### 4.6 网络配置命令

| 命令 | 功能 | 示例 |
|------|------|------|
| `SetIP:<IP>` | 设置IP地址 | `SetIP:192.168.2.100` |
| `SetNetMask:<Mask>` | 设置子网掩码 | `SetNetMask:255.255.255.0` |
| `SetGateway:<GW>` | 设置网关 | `SetGateway:192.168.2.1` |
| `TcpPort:<Port>` | 设置TCP端口 | `TcpPort:5025` |
| `SetMac:<MAC>` | 设置MAC地址 | `SetMac:00:11:22:33:44:55` |

> ⚠️ 修改网络配置后需要重启设备生效

---

### 4.7 命令汇总表

| 命令 | 功能 | 类型 |
|------|------|:----:|
| `*IDN?` | 查询设备标识 | 查询 |
| `ifconfig` | 查询网络配置 | 查询 |
| `ROUTE:PATHSWITCH:<A1>:<A2>` | 建立路径（高级） | 设置 |
| `ROUTE:PATHSWITCH?` | 查询路径状态 | 查询 |
| `ROUTE:CHANGETO:<N1>:<N2>` | 切换开关（底层） | 设置 |
| `ROUTE:CHANGETO:<N1>?` | 查询开关状态 | 查询 |
| `ROUTE:COUNT?` | 查询切换计数 | 查询 |

---

## 5. 软件操作指南

### 5.1 控制面板操作

#### PATHSWITCH — 建立路径

用于快速建立COM端口到通道的射频路径。

**操作步骤**：
1. 在"COM1 端口"下拉框选择目标通道（0~72）
   - 选择 `0`：透传模式（全部CHn直连CPn）
   - 选择 `1~72`：COM1连接指定CHn通道
2. 在"COM2 端口"下拉框选择目标通道（0、73~76）
   - 选择 `0`：COM2断开
   - 选择 `73~76`：COM2连接特殊通道
3. 点击 **"建立路径"** 按钮
4. 查看日志确认执行结果

#### CHANGETO — 快速切换

用于直接控制单个开关的状态。

**操作步骤**：
1. 在"开关编号"下拉框选择目标开关（1~83）
2. 在"目标端口"下拉框选择目标状态：
   - **SW1~SW72**：状态1（CHn）或 状态2（CPn）
   - **SW73~SW81**：状态0~8（选择组内开关）
   - **SW82**：状态0~9（选择分组）
   - **SW83**：状态0~4（选择CH73~CH76）
3. 点击 **"快速切换"** 按钮
4. 查看日志确认执行结果

### 5.2 命令输入

除了使用控制面板，还可以直接输入SCPI命令：

1. 切换到"命令输入"标签
2. 在输入框中输入命令（可点击命令模板快速填充）
3. 按 **Enter** 或点击 **"发送命令"** 按钮
4. 查看设备响应和日志

---

## 6. 典型应用场景

### 6.1 多通道S21测量（VNA配合）

测量64通道被测件的S21参数，连接方式：
- VNA Port1 → 开关矩阵 COM1
- VNA Port2 → 开关矩阵 COM2

#### 第一组（CH1~CH16 ↔ CH73）

```bash
# 步骤1：COM2连接CH73，COM1连接CH1
ROUTE:PATHSWITCH:1:73
# 测S21（待测件连在CH1、CH73之间）

# 步骤2：切换到CH2
ROUTE:PATHSWITCH:2:73
# 测S21（待测件连在CH2、CH73之间）

# ... 重复至CH16
ROUTE:PATHSWITCH:16:73
```

#### 第二组（CH17~CH32 ↔ CH74）

```bash
ROUTE:PATHSWITCH:17:74  # CH17 ↔ CH74
ROUTE:PATHSWITCH:18:74  # CH18 ↔ CH74
# ... 重复至CH32
ROUTE:PATHSWITCH:32:74
```

#### 第三组（CH33~CH48 ↔ CH75）

```bash
ROUTE:PATHSWITCH:33:75  # CH33 ↔ CH75
ROUTE:PATHSWITCH:34:75  # CH34 ↔ CH75
# ... 重复至CH48
ROUTE:PATHSWITCH:48:75
```

#### 第四组（CH49~CH64 ↔ CH76）

```bash
ROUTE:PATHSWITCH:49:76  # CH49 ↔ CH76
ROUTE:PATHSWITCH:50:76  # CH50 ↔ CH76
# ... 重复至CH64
ROUTE:PATHSWITCH:64:76
```

### 6.2 CH与CP切换测试

如需测量CH通道与CP通道之间的差异：

```bash
# 连接CH10
ROUTE:CHANGETO:10:1

# 切换到CP10
ROUTE:CHANGETO:10:2
```

---

## 附录：快速参考卡

```
┌─────────────────────────────────────────────────────────────┐
│                     开关矩阵快速参考                           │
├─────────────────────────────────────────────────────────────┤
│  建立路径    ROUTE:PATHSWITCH:<CH通道>:<COM2通道>              │
│  快速切换    ROUTE:CHANGETO:<开关号>:<状态>                    │
│  查询路径    ROUTE:PATHSWITCH?                               │
│  查询状态    ROUTE:CHANGETO:<开关号>?                          │
├─────────────────────────────────────────────────────────────┤
│  开关范围：                                                   │
│    SW1~SW72:  状态 1(CH) 或 2(CP)                            │
│    SW73~SW81: 状态 0~8（选择组内1~8号）                        │
│    SW82:      状态 0~9（选择分组1~9）                          │
│    SW83:      状态 0~4（选择CH73~76）                         │
├─────────────────────────────────────────────────────────────┤
│  PATHSWITCH参数：                                            │
│    A1 = 0~72  (0=透传, 1~72=CH通道)                          │
│    A2 = 0,73~76 (0=断开, 73~76=COM2通道)                     │
└─────────────────────────────────────────────────────────────┘
```

